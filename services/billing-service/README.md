# Billing Service

–°–µ—Ä–≤–∏—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.

## üìã –û–ø–∏—Å–∞–Ω–∏–µ

Billing Service –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞:

- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞ (–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞)
- –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤ –∑–∞ –∑–∞–∫–∞–∑—ã
- –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- Freeze/unfreeze —Å—Ä–µ–¥—Å—Ç–≤
- Webhook –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **PostgreSQL** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **Redis** - –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–ª–∞–Ω—Å–æ–≤ –∏ –ª–æ–∫ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- **Auth Service** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
- **Crypto Payment Gateway** - –ø—Ä–∏–µ–º –ø–ª–∞—Ç–µ–∂–µ–π

### –í–Ω–µ—à–Ω–∏–µ API

- Order Service (—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞ –∑–∞–∫–∞–∑—ã)
- Notification Service (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö)

## üöÄ API Endpoints

### GET /billing/balance

–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Headers:**

```
Authorization: Bearer {accessToken}
```

**Response:**

```json
{
  "userId": "uuid",
  "balance": 100.5,
  "frozen": 25.0,
  "available": 75.5,
  "currency": "USD"
}
```

### POST /billing/deposit

–°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Å—á–µ—Ç–∞.

**Request:**

```json
{
  "amount": 100.0,
  "currency": "USD",
  "paymentMethod": "crypto",
  "cryptoCurrency": "USDT"
}
```

**Response:**

```json
{
  "depositId": "uuid",
  "paymentAddress": "crypto_address",
  "amount": 100.0,
  "expiresAt": "2024-01-01T12:00:00Z",
  "status": "pending"
}
```

### GET /billing/transactions

–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

**Query Parameters:**

- `page`: –Ω–æ–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (default: 1)
- `limit`: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π (default: 20, max: 100)
- `type`: —Ñ–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É (deposit, withdraw, freeze, unfreeze)

**Response:**

```json
{
  "transactions": [
    {
      "id": "uuid",
      "type": "deposit",
      "amount": 100.0,
      "status": "completed",
      "createdAt": "2024-01-01T10:00:00Z"
    }
  ],
  "pagination": {
    "page": 1,
    "limit": 20,
    "total": 45
  }
}
```

### POST /billing/freeze (Internal)

–ó–∞–º–æ—Ä–æ–∑–∫–∞ —Å—Ä–µ–¥—Å—Ç–≤ –¥–ª—è –∑–∞–∫–∞–∑–∞.

**Request:**

```json
{
  "userId": "uuid",
  "amount": 25.0,
  "orderId": "uuid",
  "reason": "order_payment"
}
```

**Response:**

```json
{
  "freezeId": "uuid",
  "status": "success"
}
```

### POST /billing/charge (Internal)

–°–ø–∏—Å–∞–Ω–∏–µ –∑–∞–º–æ—Ä–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤.

**Request:**

```json
{
  "freezeId": "uuid",
  "amount": 25.0
}
```

**Response:**

```json
{
  "transactionId": "uuid",
  "status": "success"
}
```

### POST /billing/webhook/payment

Webhook –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –æ—Ç –ø–ª–∞—Ç–µ–∂–Ω–æ–π —Å–∏—Å—Ç–µ–º—ã.

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **Idempotency**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã (–∑–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è)
- **Atomic transactions**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –±–∞–ª–∞–Ω—Å–æ–º –∞—Ç–æ–º–∞—Ä–Ω—ã
- **Webhook signature**: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏ webhooks
- **Rate limiting**: 10 –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–∏–Ω—É—Ç—É –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- **Audit log**: –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–µ–Ω—å–≥–∞–º–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è

## üí∞ –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞

### Freeze/Unfreeze Flow

1. –ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è
2. –ü—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Å–ø–∏—Å—ã–≤–∞—é—Ç—Å—è
3. –ü—Ä–∏ –æ—Ç–º–µ–Ω–µ –∑–∞–∫–∞–∑–∞ —Å—Ä–µ–¥—Å—Ç–≤–∞ —Ä–∞–∑–º–æ—Ä–∞–∂–∏–≤–∞—é—Ç—Å—è

### –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å

- –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: $10
- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –ø–æ—Å–ª–µ –∑–∞–∫–∞–∑–∞: $0

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit Tests

```bash
npm test -- services/billing-service
```

### Integration Tests

```bash
npm run test:integration -- billing-service
```

### Test Coverage Target

- **–ú–∏–Ω–∏–º—É–º**: 90% (—Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å —Ç—Ä–µ–±—É–µ—Ç –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø–æ–∫—Ä—ã—Ç–∏—è)
- **–¶–µ–ª—å**: 95%

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –ú–µ—Ç—Ä–∏–∫–∏

- –û–±—â–∞—è —Å—É–º–º–∞ –±–∞–ª–∞–Ω—Å–æ–≤
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω—ã—Ö/–Ω–µ—É—Å–ø–µ—à–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞—Ç–µ–∂–∞
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≤–∏—Å—à–∏—Ö –ø–ª–∞—Ç–µ–∂–µ–π

### Alerts

- –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å—Ç–∞–ª –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –±–∞–≥)
- –ü–ª–∞—Ç–µ–∂ –≤–∏—Å–∏—Ç –≤ pending > 1 —á–∞—Å–∞
- Spike –≤ failed —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö

## üöß –°—Ç–∞—Ç—É—Å

**–í–µ—Ä—Å–∏—è**: 0.0.0 (–Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω)
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç**: üî¥ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π (–±–ª–æ–∫–∏—Ä—É–µ—Ç Order Service)

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [API Specification](../../docs/api/billing-service.yaml)
- [Payment Flow](../../docs/architecture/payment-flow.md)
- [Database Schema](../../docs/architecture/database-schema.md)
