#!/bin/bash
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¸Ñ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° Claude Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÑ‚ Ð·Ð°Ð´Ð°Ñ‡Ñƒ

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/config.sh" ]; then
    source "$SCRIPT_DIR/config.sh"
fi

TASK_DESCRIPTION=$1
SUCCESS=$2  # true/false

echo "âœ… Task completed: $TASK_DESCRIPTION (success: $SUCCESS)"

if [[ $SUCCESS == "true" ]]; then
    # 1. Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
    if [ -f "package.json" ]; then
        echo "ðŸ” Running validation..."
        npm run validate 2>/dev/null || echo "âš ï¸  Validation failed or not configured yet"
    fi

    # 2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .claude.md ÑÐµÐºÑ†Ð¸ÑŽ "ðŸ“ ÐÐµÐ´Ð°Ð²Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ"
    if [ -f ".claude.md" ]; then
        DATE=$(date +%Y-%m-%d)
        COMMIT_HASH=$(git log -1 --pretty=%h 2>/dev/null || echo "no-commit")
        # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð¿Ð¸ÑÑŒ Ð² Ð½Ð°Ñ‡Ð°Ð»Ð¾ ÑÐµÐºÑ†Ð¸Ð¸ "ÐÐµÐ´Ð°Ð²Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ"
        TEMP_FILE=".claude.md.tmp"
        awk -v date="$DATE" -v hash="$COMMIT_HASH" -v desc="$TASK_DESCRIPTION" '
            /## ðŸ“ ÐÐµÐ´Ð°Ð²Ð½Ð¸Ðµ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ/ {
                print $0
                print ""
                print "- [" date "] (" hash ") " desc
                next
            }
            { print }
        ' .claude.md > "$TEMP_FILE" && mv "$TEMP_FILE" .claude.md
    fi

    # 3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð² Linear
    if [ "$ENABLE_LINEAR" = true ] && [ -n "$LINEAR_ISSUE_ID" ]; then
        echo "âœ“ Updating Linear issue to Done..."
        claude mcp linear update-issue \
            --issue-id "$LINEAR_ISSUE_ID" \
            --state "Done" 2>/dev/null || echo "â„¹ï¸  Linear issue ID not set"
    fi

    # 4. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ GitHub issue Ñ Ñ€ÐµÐ·ÑŽÐ¼Ðµ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
    if [ "$ENABLE_GITHUB" = true ] && [ -n "$GITHUB_REPO" ]; then
        echo "ðŸ“ Creating GitHub completion issue..."
        ISSUE_BODY="Task completed successfully

## Description
$TASK_DESCRIPTION

## Timestamp
$(date)

ðŸ¤– Auto-generated by Claude Code hooks"

        claude mcp github create-issue \
            --repo "$GITHUB_REPO" \
            --title "âœ… Completed: $TASK_DESCRIPTION" \
            --body "$ISSUE_BODY" \
            --labels "enhancement,completed" 2>/dev/null && echo "âœ“ GitHub issue created" || echo "â„¹ï¸  GitHub repo not configured"
    fi

    # 5. ÐŸÑ€ÐµÐ´Ð»Ð¾Ð¶Ð¸Ñ‚ÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ commit
    echo ""
    echo "ðŸŽ‰ Task completed successfully!"
    echo "ðŸ“ Ready to commit? Use: git add . && git commit -m \"feat: $TASK_DESCRIPTION\""
else
    echo "âŒ Task failed. Review errors and try again."

    # Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ GitHub issue Ð´Ð»Ñ failed task
    if [ "$ENABLE_GITHUB" = true ] && [ "$AUTO_CREATE_BUG_ISSUES" = true ] && [ -n "$GITHUB_REPO" ]; then
        echo "ðŸ› Creating GitHub issue for failed task..."
        ISSUE_BODY="Task failed and needs investigation

## Task Description
$TASK_DESCRIPTION

## Timestamp
$(date)

ðŸ¤– Auto-generated by Claude Code hooks"

        claude mcp github create-issue \
            --repo "$GITHUB_REPO" \
            --title "ðŸ› Failed: $TASK_DESCRIPTION" \
            --body "$ISSUE_BODY" \
            --labels "bug,needs-investigation" 2>/dev/null && echo "âœ“ Bug issue created"
    fi
fi
