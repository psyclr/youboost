#!/bin/bash
# –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è –∫–æ–≥–¥–∞ Claude –∑–∞–≤–µ—Ä—à–∞–µ—Ç –∑–∞–¥–∞—á—É

TASK_DESCRIPTION=$1
SUCCESS=$2  # true/false

echo "‚úÖ Task completed: $TASK_DESCRIPTION (success: $SUCCESS)"

if [[ $SUCCESS == "true" ]]; then
    # 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏
    npm run validate 2>/dev/null || echo "‚ö†Ô∏è  Validation failed or not configured yet"

    # 2. –û–±–Ω–æ–≤–∏—Ç—å .claude.md —Å–µ–∫—Ü–∏—é "üìù –ù–µ–¥–∞–≤–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    if [ -f ".claude.md" ]; then
        DATE=$(date +%Y-%m-%d)
        COMMIT_HASH=$(git log -1 --pretty=%h 2>/dev/null || echo "no-commit")
        echo "- [$DATE] ($COMMIT_HASH) $TASK_DESCRIPTION" >> .claude.md.tmp
        cat .claude.md >> .claude.md.tmp
        mv .claude.md.tmp .claude.md
    fi

    # 3. –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É –≤ Notion (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
    # claude mcp notion update-task "$TASK_DESCRIPTION" --status "Done"

    # 4. –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–æ–∑–¥–∞—Ç—å commit
    echo ""
    echo "üéâ Task completed successfully!"
    echo "üìù Ready to commit? Use: /codex-commit or git commit manually"
else
    echo "‚ùå Task failed. Review errors and try again."
fi
