#!/bin/bash
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¸Ñ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° Claude ÑÑ‚Ð°Ð»ÐºÐ¸Ð²Ð°ÐµÑ‚ÑÑ Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ¾Ð¹

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/config.sh" ]; then
    source "$SCRIPT_DIR/config.sh"
fi

ERROR_MESSAGE=$1
ERROR_CONTEXT=$2

echo "âŒ Error occurred: $ERROR_MESSAGE"

# 1. Ð›Ð¾Ð³Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Ñ„Ð°Ð¹Ð»
LOG_FILE=".claude/error.log"
mkdir -p .claude
echo "[$(date)] $ERROR_MESSAGE" >> "$LOG_FILE"
echo "Context: $ERROR_CONTEXT" >> "$LOG_FILE"
echo "---" >> "$LOG_FILE"

# 2. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ GitHub issue Ð´Ð»Ñ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº
if [ "$ENABLE_GITHUB" = true ] && [ "$AUTO_CREATE_BUG_ISSUES" = true ] && [ -n "$GITHUB_REPO" ]; then
    echo "ðŸ› Creating GitHub bug issue..."
    ERROR_BODY="## Error Description
$ERROR_MESSAGE

## Context
\`\`\`
$ERROR_CONTEXT
\`\`\`

## Timestamp
$(date)

ðŸ¤– Auto-generated by Claude Code hooks"

    claude mcp github create-issue \
        --repo "$GITHUB_REPO" \
        --title "ðŸ› Error: $ERROR_MESSAGE" \
        --body "$ERROR_BODY" \
        --labels "bug,automated" 2>/dev/null && echo "âœ“ Bug issue created" || echo "â„¹ï¸  GitHub repo not configured"
fi

# 3. Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ context Ð´Ð»Ñ Ð¿Ð¾ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð°Ð½Ð°Ð»Ð¸Ð·Ð°
mkdir -p .claude/errors
ERROR_ID=$(date +%s)
ERROR_FILE=".claude/errors/error-${ERROR_ID}.txt"
cat > "$ERROR_FILE" <<EOF
Timestamp: $(date)
Error: $ERROR_MESSAGE

Context:
$ERROR_CONTEXT
EOF

echo "ðŸ“ Error logged to: $ERROR_FILE"
