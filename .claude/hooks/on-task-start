#!/bin/bash
# Ð¢Ñ€Ð¸Ð³Ð³ÐµÑ€Ð¸Ñ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° Claude Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ñ€Ð°Ð±Ð¾Ñ‚Ñƒ Ð½Ð°Ð´ Ð½Ð¾Ð²Ð¾Ð¹ Ð·Ð°Ð´Ð°Ñ‡ÐµÐ¹

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/config.sh" ]; then
    source "$SCRIPT_DIR/config.sh"
fi

TASK_DESCRIPTION=$1

echo "ðŸš€ Starting task: $TASK_DESCRIPTION"

# 1. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°Ð´Ð°Ñ‡Ñƒ Ð² Linear (Ñ‡ÐµÑ€ÐµÐ· MCP)
if [ "$ENABLE_LINEAR" = true ] && [ "$AUTO_CREATE_LINEAR_TASKS" = true ]; then
    if [ -n "$LINEAR_TEAM_ID" ]; then
        echo "ðŸ“‹ Creating Linear issue..."
        claude mcp linear create-issue \
            --team-id "$LINEAR_TEAM_ID" \
            --title "$TASK_DESCRIPTION" \
            --state "In Progress" 2>/dev/null && echo "âœ“ Linear task created" || echo "âš ï¸  Failed to create Linear task"
    else
        echo "â„¹ï¸  Linear Team ID not configured. Edit .claude/hooks/config.sh"
    fi
fi

# 2. Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ feature branch ÐµÑÐ»Ð¸ ÐµÑ‰Ðµ Ð½ÐµÑ‚
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
if [[ $? -eq 0 ]]; then
    if [[ $CURRENT_BRANCH == "main" || $CURRENT_BRANCH == "master" ]]; then
        BRANCH_NAME=$(echo "$TASK_DESCRIPTION" | sed 's/ /-/g' | tr '[:upper:]' '[:lower:]' | head -c 50)
        git checkout -b "feat/$BRANCH_NAME" 2>/dev/null && echo "âœ“ Created branch: feat/$BRANCH_NAME"
    fi
else
    echo "â„¹ï¸  Not in a git repository, skipping branch creation"
fi

# 3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .claude.md ÑÐµÐºÑ†Ð¸ÑŽ "ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð¾ÐºÑƒÑ"
if [ -f ".claude.md" ]; then
    # macOS sed
    sed -i '' "s|## ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð¾ÐºÑƒÑ.*|## ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð¾ÐºÑƒÑ\\n\\n$TASK_DESCRIPTION|" .claude.md 2>/dev/null || \
    # Linux sed
    sed -i "s|## ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð¾ÐºÑƒÑ.*|## ðŸŽ¯ Ð¢ÐµÐºÑƒÑ‰Ð¸Ð¹ Ñ„Ð¾ÐºÑƒÑ\\n\\n$TASK_DESCRIPTION|" .claude.md 2>/dev/null
fi

echo "âœ“ Task started successfully"
