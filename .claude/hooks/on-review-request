#!/bin/bash
# –¢—Ä–∏–≥–≥–µ—Ä–∏—Ç—Å—è –∫–æ–≥–¥–∞ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è code review

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/config.sh" ]; then
    source "$SCRIPT_DIR/config.sh"
fi

FILES_TO_REVIEW=$@

echo "üîç Starting code review for: $FILES_TO_REVIEW"

# 1. –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–æ–≤
if [[ -f "package.json" ]]; then
    echo "üìù Running ESLint..."
    npx eslint $FILES_TO_REVIEW 2>/dev/null || echo "‚ö†Ô∏è  Lint check failed"

    echo "üîß Type checking..."
    npx tsc --noEmit 2>/dev/null || echo "‚ö†Ô∏è  Type check failed"
fi

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ test coverage –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
echo "üß™ Checking test coverage..."
MISSING_TESTS=()
for file in $FILES_TO_REVIEW; do
    if [[ $file == *.ts && $file != *.test.ts && $file != *.spec.ts ]]; then
        TEST_FILE="${file%.ts}.test.ts"
        SPEC_FILE="${file%.ts}.spec.ts"
        if [[ ! -f $TEST_FILE && ! -f $SPEC_FILE ]]; then
            echo "‚ö†Ô∏è  Missing test file for: $file"
            MISSING_TESTS+=("$file")
        fi
    fi
done

# 3. Security scan
if [[ -f "package.json" ]]; then
    echo "üîí Security audit..."
    npm audit 2>/dev/null || echo "‚ÑπÔ∏è  No vulnerabilities found or audit not available"
fi

# 4. Complexity analysis
if command -v jq &> /dev/null; then
    echo "üìä Complexity analysis..."
    npx eslint $FILES_TO_REVIEW --format json 2>/dev/null | jq '.[] | select(.messages[].ruleId == "complexity")' 2>/dev/null || true
fi

# 5. –°–æ–∑–¥–∞—Ç—å GitHub PR review comment
if [ "$ENABLE_GITHUB" = true ] && [ "$AUTO_PR_COMMENTS" = true ] && [ -n "$GITHUB_REPO" ]; then
    # –ü–æ–ª—É—á–∏—Ç—å PR number –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ branch (–µ—Å–ª–∏ –≤ PR)
    PR_NUMBER=$(gh pr view --json number -q .number 2>/dev/null)

    if [ -n "$PR_NUMBER" ]; then
        REVIEW_SUMMARY="## Code Review Summary

### Files Reviewed
$(echo "$FILES_TO_REVIEW" | tr ' ' '\n' | sed 's/^/- /')

### Missing Tests"

        if [ ${#MISSING_TESTS[@]} -eq 0 ]; then
            REVIEW_SUMMARY="$REVIEW_SUMMARY
‚úÖ All files have tests"
        else
            for file in "${MISSING_TESTS[@]}"; do
                REVIEW_SUMMARY="$REVIEW_SUMMARY
- ‚ö†Ô∏è $file"
            done
        fi

        REVIEW_SUMMARY="$REVIEW_SUMMARY

ü§ñ Automated review by Claude Code"

        echo "üìù Creating PR review comment..."
        gh pr comment "$PR_NUMBER" --body "$REVIEW_SUMMARY" 2>/dev/null && echo "‚úì PR comment added" || echo "‚ÑπÔ∏è  Failed to add PR comment"
    fi
fi

echo ""
echo "‚úÖ Code review checks completed"
if [ ${#MISSING_TESTS[@]} -gt 0 ]; then
    echo ""
    echo "‚ö†Ô∏è  Please add tests for ${#MISSING_TESTS[@]} file(s)"
fi
