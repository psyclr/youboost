#!/bin/bash
# Ğ¢Ñ€Ğ¸Ğ³Ğ³ĞµÑ€Ğ¸Ñ‚ÑÑ ĞºĞ¾Ğ³Ğ´Ğ° Claude ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½ Ğ² plan mode

# Load configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/config.sh" ]; then
    source "$SCRIPT_DIR/config.sh"
fi

PLAN_FILE=$1

echo "ğŸ“‹ Plan created: $PLAN_FILE"

# 1. Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ½Ğ°
if [ -f "$PLAN_FILE" ]; then
    if ! grep -q "## Verification" "$PLAN_FILE" 2>/dev/null; then
        echo "âš ï¸  Warning: Plan missing verification section"
    fi
else
    echo "âš ï¸  Plan file not found: $PLAN_FILE"
    exit 1
fi

# 2. Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¿Ğ¸Ñ Ğ¿Ğ»Ğ°Ğ½Ğ° Ğ² docs/plans/
mkdir -p docs/plans
PLAN_NAME=$(basename "$PLAN_FILE")
DATE=$(date +%Y-%m-%d)
SAVED_PLAN="docs/plans/${DATE}-${PLAN_NAME}"
cp "$PLAN_FILE" "$SAVED_PLAN" 2>/dev/null && echo "âœ“ Plan saved to: $SAVED_PLAN"

# 3. ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ .claude.md Ñ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹ Ğ½Ğ° Ğ¿Ğ»Ğ°Ğ½
if [ -f ".claude.md" ]; then
    echo "- [Plan: ${DATE}]($SAVED_PLAN)" >> .claude.md
fi

# 4. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ GitHub issue Ñ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ¼
if [ "$ENABLE_GITHUB" = true ] && [ -n "$GITHUB_REPO" ]; then
    PLAN_TITLE=$(head -n 1 "$PLAN_FILE" 2>/dev/null | sed 's/^# //' || echo "Implementation Plan")
    PLAN_CONTENT=$(cat "$PLAN_FILE")

    echo "ğŸ“ Creating GitHub issue with plan..."
    claude mcp github create-issue \
        --repo "$GITHUB_REPO" \
        --title "ğŸ“‹ Plan: $PLAN_TITLE" \
        --body "$PLAN_CONTENT" \
        --labels "planning,documentation" 2>/dev/null && echo "âœ“ GitHub issue created" || echo "â„¹ï¸  GitHub repo not configured"
fi

# 5. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Linear issue Ğ¸Ğ· Ğ¿Ğ»Ğ°Ğ½Ğ°
if [ "$ENABLE_LINEAR" = true ] && [ -n "$LINEAR_TEAM_ID" ]; then
    PLAN_TITLE=$(head -n 1 "$PLAN_FILE" 2>/dev/null | sed 's/^# //' || echo "Implementation Plan")

    echo "ğŸ“‹ Creating Linear issue from plan..."
    claude mcp linear create-issue \
        --team-id "$LINEAR_TEAM_ID" \
        --title "$PLAN_TITLE" \
        --description "See plan: $SAVED_PLAN" \
        --state "Planned" 2>/dev/null && echo "âœ“ Linear issue created" || echo "â„¹ï¸  Linear not configured"
fi

echo "âœ“ Plan processing complete"
